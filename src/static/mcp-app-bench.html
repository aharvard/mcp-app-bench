<!DOCTYPE html>
<html>
  <head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-primary: #18181b;
        --bg-terminal: #0a0a0a;
        --text-primary: #fafafa;
        --text-secondary: #a1a1aa;
        --border: #3f3f46;
      }

      .theme-light {
        --bg-primary: #fafafa;
        --bg-terminal: #f4f4f5;
        --text-primary: #18181b;
        --text-secondary: #52525b;
        --border: #e4e4e7;
      }

      .theme-dark {
        --bg-primary: #18181b;
        --bg-terminal: #0a0a0a;
        --text-primary: #fafafa;
        --text-secondary: #a1a1aa;
        --border: #3f3f46;
      }

      html {
        overflow: hidden;
      }
      body {
        margin: 0;
        padding: 24px 24px 0;
        color: var(--text-primary);
        background-color: var(--bg-primary);
        font-family: "Instrument Serif", system-ui, sans-serif;
        font-weight: 400;
        font-style: normal;
        transition: background-color 0.15s ease, color 0.15s ease;
      }
      h1 {
        font-size: min(max(4rem, 8vw), 8rem);
        text-align: center;
        line-height: 0.95;
        margin: 2rem auto 3rem;
        letter-spacing: -0.02em;
      }
      .host-info-subtitle {
        text-align: center;
        margin: 0 0 2rem;
        font-family: ui-monospace, monospace;
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      .actions {
        margin-top: 1rem;
        margin-bottom: 2rem;
        text-align: center;
      }
      .actions-heading {
        margin: 0 0 0.75rem;
        letter-spacing: 0.05em;
        color: var(--text-primary);
      }
      .actions-note {
        color: var(--text-secondary);
        font-size: 1.2rem;
      }
      .actions-buttons {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 0.5rem;
      }
      .action-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: var(--text-primary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--bg-primary);
        font-family: ui-monospace, monospace;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.15s ease;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .action-btn:hover {
        background: var(--bg-primary);
        color: var(--text-primary);
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }
      .action-btn:active {
        transform: translateY(0);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .action-btn code {
        color: var(--bg-primary);
        opacity: 0.7;
        font-size: 0.75rem;
      }
      .action-btn:hover code {
        color: var(--text-primary);
        opacity: 0.7;
      }
      .action-btn:disabled {
        opacity: 0.25;
        cursor: not-allowed;
        transform: none;
      }
      .action-btn:disabled:hover {
        background: var(--bg-primary);
        transform: none;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
      }
      .theme-light .action-btn {
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .theme-light .action-btn:hover {
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
      }
      .terminal {
        margin: 1.5rem -24px 0;
        background: var(--bg-terminal);
        border-top: 1px solid var(--border);
        box-shadow: inset 0 1px 4px rgba(0, 0, 0, 0.5);
        transition: background-color 0.15s ease, border-color 0.15s ease;
      }
      .theme-light .terminal {
        box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.08);
      }
      .terminal-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        align-items: stretch;
      }
      .terminal-grid > .terminal-section {
        padding: 1.5rem 24px;
      }
      .terminal-grid > .terminal-section:not(:last-child) {
        border-right: 1px solid var(--border);
      }
      @media (max-width: 700px) {
        .terminal-grid > .terminal-section:not(:last-child) {
          border-right: none;
          border-bottom: 1px solid var(--border);
        }
      }
      .terminal-section h2 {
        margin: 0 0 0.75rem;
        font-family: ui-monospace, monospace;
        font-size: 0.75rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #71717a;
      }
      /* Styles table */
      .styles-table {
        width: 100%;
        border-collapse: collapse;
        font-family: ui-monospace, monospace;
        font-size: 0.75rem;
      }
      .styles-table th {
        text-align: left;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid var(--border);
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-size: 0.625rem;
      }
      .styles-table td {
        padding: 0.375rem 0.75rem;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
      }
      .styles-table tr:last-child td {
        border-bottom: none;
      }
      .styles-table .var-name {
        color: #a78bfa;
        word-break: break-all;
      }
      .theme-light .styles-table .var-name {
        color: #7c3aed;
      }
      .styles-table .var-value {
        color: #86efac;
        word-break: break-all;
        max-width: 200px;
      }
      .theme-light .styles-table .var-value {
        color: #16a34a;
      }
      .color-swatch {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
      }
      .color-swatch-box {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        border: 1px solid var(--border);
        flex-shrink: 0;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
      }
      .styles-category {
        margin-bottom: 1.5rem;
      }
      .styles-category:last-child {
        margin-bottom: 0;
      }
      .styles-category-title {
        font-family: ui-monospace, monospace;
        font-size: 0.6875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: var(--text-secondary);
        margin: 0 0 0.5rem;
        padding: 0.25rem 0;
        border-bottom: 1px solid var(--border);
      }
      .styles-empty {
        color: var(--text-secondary);
        font-style: italic;
        padding: 1rem 0;
      }
      .styles-scroll {
        max-height: 400px;
        overflow-y: auto;
      }
      /* Collapsible JSON viewer */
      .json-viewer {
        font-family: ui-monospace, monospace;
        font-size: 0.8125rem;
        line-height: 1.5;
        color: var(--text-primary);
      }
      .json-viewer .jv-toggle {
        cursor: pointer;
        user-select: none;
        display: inline-block;
        width: 1em;
        text-align: center;
        color: var(--text-secondary);
        margin-right: 0.25em;
      }
      .json-viewer .jv-toggle:hover {
        color: var(--text-primary);
      }
      .json-viewer .jv-collapsed > .jv-children {
        display: none;
      }
      .json-viewer .jv-collapsed > .jv-toggle::before {
        content: 'â–¶';
      }
      .json-viewer .jv-expanded > .jv-toggle::before {
        content: 'â–¼';
      }
      .json-viewer .jv-children {
        padding-left: 1.25em;
        border-left: 1px solid var(--border);
        margin-left: 0.5em;
      }
      .json-viewer .jv-key {
        color: #a78bfa;
      }
      .theme-light .json-viewer .jv-key {
        color: #7c3aed;
      }
      .json-viewer .jv-string {
        color: #86efac;
      }
      .theme-light .json-viewer .jv-string {
        color: #16a34a;
      }
      .json-viewer .jv-number {
        color: #fcd34d;
      }
      .theme-light .json-viewer .jv-number {
        color: #ca8a04;
      }
      .json-viewer .jv-boolean {
        color: #67e8f9;
      }
      .theme-light .json-viewer .jv-boolean {
        color: #0891b2;
      }
      .json-viewer .jv-null {
        color: #f87171;
      }
      .theme-light .json-viewer .jv-null {
        color: #dc2626;
      }
      .json-viewer .jv-punctuation {
        color: var(--text-secondary);
      }
      .json-viewer .jv-preview {
        color: var(--text-secondary);
        font-style: italic;
      }
      .json-viewer .jv-line {
        white-space: nowrap;
      }
      .json-viewer .jv-item {
        margin: 0.125em 0;
      }
      /* Message Log */
      .message-log {
        max-height: 400px;
        overflow-y: auto;
        font-family: ui-monospace, monospace;
        font-size: 0.75rem;
      }
      .message-row {
        display: grid;
        grid-template-columns: auto auto 1fr;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid var(--border);
        align-items: start;
      }
      .message-row:last-child {
        border-bottom: none;
      }
      .message-time {
        color: var(--text-secondary);
        white-space: nowrap;
        font-size: 0.6875rem;
      }
      .message-direction {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        flex-shrink: 0;
      }
      .message-direction.sent {
        background: rgba(134, 239, 172, 0.15);
        color: #86efac;
      }
      .theme-light .message-direction.sent {
        background: rgba(22, 163, 74, 0.1);
        color: #16a34a;
      }
      .message-direction.received {
        background: rgba(124, 172, 255, 0.15);
        color: #7cacff;
      }
      .theme-light .message-direction.received {
        background: rgba(92, 152, 249, 0.1);
        color: #5c98f9;
      }
      .message-content {
        min-width: 0;
      }
      .message-method {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 0.25rem;
        word-break: break-all;
      }
      .message-body {
        color: var(--text-secondary);
        font-size: 0.6875rem;
        line-height: 1.4;
      }
      .message-body .json-viewer {
        font-size: 0.6875rem;
      }
      .message-empty {
        color: var(--text-secondary);
        font-style: italic;
        padding: 1rem 0;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <p class="host-info-subtitle" id="host-info-subtitle">Connecting...</p>
    <h1>MCP App Bench</h1>
    <div class="actions">
      <h2 class="actions-heading">Host Requests</h2>
      <div class="actions-buttons">
        <button class="action-btn" id="btn-open-link">
        Open Link <code>ui/open-link</code>
        </button>
        <button class="action-btn" id="btn-message">
        Send Message <code>ui/message</code>
        </button>
        <button class="action-btn" id="btn-size-change">
        Size Change <code>ui/notifications/size-changed</code>
        </button>
      </div>
    </div>
    <div class="actions">
      <h2 class="actions-heading">Server Requests</h2>
      <div class="actions-buttons">
        <button class="action-btn" id="btn-tools-call">
        Call Tool <code>tools/call</code>
        </button>
        <button class="action-btn" id="btn-resources-list">
        List Resources <code>resources/list</code>
        </button>
        <button class="action-btn" id="btn-resources-templates-list">
        List Templates <code>resources/templates/list</code>
        </button>
        <button class="action-btn" id="btn-resources-read">
        Read Resource <code>resources/read</code>
        </button>
        <button class="action-btn" id="btn-prompts-list">
        List Prompts <code>prompts/list</code>
        </button>
        <button class="action-btn" id="btn-notifications-message">
        Log Message <code>notifications/message</code>
        </button>
        <button class="action-btn" id="btn-ping">
        Ping <code>ping</code>
        </button>
      </div>
    </div>
    <div class="terminal">
      <div class="terminal-grid">
        <div class="terminal-section">
          <h2>Host Data</h2>
          <div class="json-viewer" id="host-info-content">Initializing...</div>
        </div>
        <div class="terminal-section">
          <h2>ðŸŽ¨ Host Styles</h2>
          <div class="styles-scroll" id="host-styles-content">
            <div class="styles-empty">Waiting for host styles...</div>
          </div>
        </div>
        <div class="terminal-section">
          <h2>Tool Data</h2>
          <div class="json-viewer" id="tool-data-content">Waiting...</div>
        </div>
        <div class="terminal-section">
          <h2>ðŸ“¨ Message Log</h2>
          <div class="message-log" id="message-log-content"></div>
        </div>
      </div>
    </div>
    <script>
      (function () {
        let requestId = 1;
        const pendingRequests = new Map();
        let currentHostInfo = null;
        let currentToolData = {
          toolInput: null,
          toolInputPartial: null,
          toolResult: null,
          toolCancelled: null
        };

        // Message log
        const messageLog = [];
        const MAX_MESSAGES = 100;

        function getTimestamp() {
          return new Date().toLocaleTimeString('en-US', { 
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });
        }

        function logMessage(direction, method, content) {
          messageLog.push({
            time: getTimestamp(),
            direction: direction, // 'sent' or 'received'
            method: method,
            content: content
          });
          if (messageLog.length > MAX_MESSAGES) {
            messageLog.shift();
          }
          renderMessageLog();
        }

        function renderMessageLog() {
          const container = document.getElementById('message-log-content');
          if (!container) return;

          if (messageLog.length === 0) {
            container.innerHTML = '<div class="message-empty">No messages yet</div>';
            return;
          }

          let html = '';
          // Render in reverse order (newest first)
          for (let i = messageLog.length - 1; i >= 0; i--) {
            const msg = messageLog[i];
            const dirIcon = msg.direction === 'sent' ? 'â†‘' : 'â†“';
            const dirClass = msg.direction;
            
            html += '<div class="message-row">';
            html += '<span class="message-time">' + msg.time + '</span>';
            html += '<span class="message-direction ' + dirClass + '" title="' + (msg.direction === 'sent' ? 'Sent to host' : 'Received from host') + '">' + dirIcon + '</span>';
            html += '<div class="message-content">';
            html += '<div class="message-method">' + escapeHtml(msg.method) + '</div>';
            if (msg.content !== undefined && msg.content !== null) {
              html += '<div class="message-body">';
              html += renderJsonValue(msg.content, 0, 2);
              html += '</div>';
            }
            html += '</div>';
            html += '</div>';
          }

          container.innerHTML = html;
        }

        function setTheme(theme) {
          document.body.classList.remove('theme-light', 'theme-dark');
          if (theme === 'light') {
            document.body.classList.add('theme-light');
          } else {
            document.body.classList.add('theme-dark');
          }
        }

        function sendSizeChanged() {
          const width = document.body.scrollWidth;
          const height = document.body.scrollHeight;
          const params = { width, height };
          window.parent.postMessage({
            jsonrpc: '2.0',
            method: 'ui/notifications/size-changed',
            params: params
          }, '*');
          // Don't log size-changed to avoid spam
        }

        function sendRequest(method, params) {
          return new Promise((resolve, reject) => {
            const id = requestId++;
            pendingRequests.set(id, { resolve, reject, method, params });
            logMessage('sent', method + ' (request)', params);
            window.parent.postMessage({
              jsonrpc: '2.0',
              id: id,
              method: method,
              params: params
            }, '*');
          });
        }

        function sendNotification(method, params) {
          logMessage('sent', method + ' (notification)', params);
          window.parent.postMessage({
            jsonrpc: '2.0',
            method: method,
            params: params
          }, '*');
        }

        // Collapsible JSON Viewer
        function escapeHtml(str) {
          return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;');
        }

        function getPreview(value) {
          if (Array.isArray(value)) {
            return '[' + value.length + ' items]';
          }
          if (typeof value === 'object' && value !== null) {
            const keys = Object.keys(value);
            return '{' + keys.length + ' keys}';
          }
          return '';
        }

        function renderJsonValue(value, depth, collapseDepth) {
          if (value === null) {
            return '<span class="jv-null">null</span>';
          }
          if (typeof value === 'boolean') {
            return '<span class="jv-boolean">' + value + '</span>';
          }
          if (typeof value === 'number') {
            return '<span class="jv-number">' + value + '</span>';
          }
          if (typeof value === 'string') {
            return '<span class="jv-string">"' + escapeHtml(value) + '"</span>';
          }
          if (Array.isArray(value)) {
            if (value.length === 0) {
              return '<span class="jv-punctuation">[]</span>';
            }
            const collapsed = depth >= collapseDepth ? 'jv-collapsed' : 'jv-expanded';
            let html = '<span class="jv-item ' + collapsed + '">';
            html += '<span class="jv-toggle" onclick="this.parentElement.classList.toggle(\'jv-collapsed\');this.parentElement.classList.toggle(\'jv-expanded\');"></span>';
            html += '<span class="jv-punctuation">[</span>';
            html += '<span class="jv-preview">' + getPreview(value) + '</span>';
            html += '<div class="jv-children">';
            value.forEach(function(item, index) {
              html += '<div class="jv-line">';
              html += renderJsonValue(item, depth + 1, collapseDepth);
              if (index < value.length - 1) html += '<span class="jv-punctuation">,</span>';
              html += '</div>';
            });
            html += '</div>';
            html += '<span class="jv-punctuation">]</span>';
            html += '</span>';
            return html;
          }
          if (typeof value === 'object') {
            const keys = Object.keys(value);
            if (keys.length === 0) {
              return '<span class="jv-punctuation">{}</span>';
            }
            const collapsed = depth >= collapseDepth ? 'jv-collapsed' : 'jv-expanded';
            let html = '<span class="jv-item ' + collapsed + '">';
            html += '<span class="jv-toggle" onclick="this.parentElement.classList.toggle(\'jv-collapsed\');this.parentElement.classList.toggle(\'jv-expanded\');"></span>';
            html += '<span class="jv-punctuation">{</span>';
            html += '<span class="jv-preview">' + getPreview(value) + '</span>';
            html += '<div class="jv-children">';
            keys.forEach(function(key, index) {
              html += '<div class="jv-line">';
              html += '<span class="jv-key">"' + escapeHtml(key) + '"</span>';
              html += '<span class="jv-punctuation">: </span>';
              html += renderJsonValue(value[key], depth + 1, collapseDepth);
              if (index < keys.length - 1) html += '<span class="jv-punctuation">,</span>';
              html += '</div>';
            });
            html += '</div>';
            html += '<span class="jv-punctuation">}</span>';
            html += '</span>';
            return html;
          }
          return String(value);
        }

        function renderCollapsibleJson(elementId, data, collapseDepth) {
          const container = document.getElementById(elementId);
          if (!container) return;
          collapseDepth = collapseDepth !== undefined ? collapseDepth : 3;
          container.innerHTML = renderJsonValue(data, 0, collapseDepth);
        }

        function renderHostInfo() {
          renderCollapsibleJson('host-info-content', currentHostInfo, 3);
          sendSizeChanged();
        }

        function renderToolData() {
          renderCollapsibleJson('tool-data-content', currentToolData, 3);
          sendSizeChanged();
        }

        function isColorValue(value) {
          if (!value || typeof value !== 'string') return false;
          // Check for common color patterns
          return /^#[0-9a-fA-F]{3,8}$/.test(value) ||
                 /^rgb\(/.test(value) ||
                 /^rgba\(/.test(value) ||
                 /^hsl\(/.test(value) ||
                 /^hsla\(/.test(value) ||
                 /^light-dark\(/.test(value);
        }

        function categorizeStyleVariables(variables) {
          const categories = {
            'Background Colors': [],
            'Text Colors': [],
            'Border Colors': [],
            'Ring Colors': [],
            'Typography': [],
            'Border Radius': [],
            'Shadows': [],
            'Other': []
          };

          for (const [key, value] of Object.entries(variables)) {
            if (key.startsWith('--color-background-')) {
              categories['Background Colors'].push([key, value]);
            } else if (key.startsWith('--color-text-')) {
              categories['Text Colors'].push([key, value]);
            } else if (key.startsWith('--color-border-')) {
              categories['Border Colors'].push([key, value]);
            } else if (key.startsWith('--color-ring-')) {
              categories['Ring Colors'].push([key, value]);
            } else if (key.startsWith('--font-') || key.startsWith('--font-weight-')) {
              categories['Typography'].push([key, value]);
            } else if (key.startsWith('--border-radius-') || key.startsWith('--border-width-')) {
              categories['Border Radius'].push([key, value]);
            } else if (key.startsWith('--shadow-')) {
              categories['Shadows'].push([key, value]);
            } else {
              categories['Other'].push([key, value]);
            }
          }

          return categories;
        }

        function renderHostStyles(styles) {
          const container = document.getElementById('host-styles-content');
          if (!container) return;

          if (!styles || !styles.variables || Object.keys(styles.variables).length === 0) {
            container.innerHTML = '<div class="styles-empty">No styles provided by host</div>';
            sendSizeChanged();
            return;
          }

          const categories = categorizeStyleVariables(styles.variables);
          let html = '';

          for (const [category, vars] of Object.entries(categories)) {
            if (vars.length === 0) continue;

            html += '<div class="styles-category">';
            html += '<h3 class="styles-category-title">' + category + '</h3>';
            html += '<table class="styles-table"><tbody>';

            for (const [varName, value] of vars) {
              const displayName = varName.replace(/^--/, '');
              const isColor = isColorValue(value);
              
              html += '<tr>';
              html += '<td class="var-name">' + displayName + '</td>';
              html += '<td class="var-value">';
              
              if (isColor) {
                html += '<span class="color-swatch">';
                html += '<span class="color-swatch-box" style="background: ' + value + ';"></span>';
                html += '<span>' + value + '</span>';
                html += '</span>';
              } else {
                html += value;
              }
              
              html += '</td>';
              html += '</tr>';
            }

            html += '</tbody></table>';
            html += '</div>';
          }

          // Show fonts CSS if available
          if (styles.css && styles.css.fonts) {
            html += '<div class="styles-category">';
            html += '<h3 class="styles-category-title">Custom Fonts CSS</h3>';
            html += '<pre style="font-family: ui-monospace, monospace; font-size: 0.7rem; color: var(--text-secondary); white-space: pre-wrap; margin: 0; max-height: 150px; overflow-y: auto;">';
            html += styles.css.fonts.replace(/</g, '&lt;').replace(/>/g, '&gt;');
            html += '</pre>';
            html += '</div>';
          }

          container.innerHTML = html;
          sendSizeChanged();
        }

        function initializeHostInfo(result) {
          // Update subtitle with host info
          const subtitle = document.getElementById('host-info-subtitle');
          if (subtitle && result.hostInfo) {
            const name = result.hostInfo.name || 'Unknown Host';
            const version = result.hostInfo.version || '';
            subtitle.textContent = version
              ? name + ' v' + version
              : name;
          }

          currentHostInfo = {
            protocolVersion: result.protocolVersion,
            hostInfo: result.hostInfo,
            hostCapabilities: result.hostCapabilities,
            hostContext: result.hostContext || {}
          };
          renderHostInfo();

          // Render host styles separately for visual display
          if (result.hostContext && result.hostContext.styles) {
            renderHostStyles(result.hostContext.styles);
          }
        }

        function updateHostContext(params) {
          if (currentHostInfo && currentHostInfo.hostContext) {
            Object.assign(currentHostInfo.hostContext, params);
            renderHostInfo();
          }
        }

        function handleMessage(event) {
          const data = event.data;
          if (!data || typeof data !== 'object' || data.jsonrpc !== '2.0') 
            return;
          
          // Handle response to our request
          if ('id' in data && pendingRequests.has(data.id)) {
            const pending = pendingRequests.get(data.id);
            pendingRequests.delete(data.id);
            if (data.error) {
              logMessage('received', pending.method + ' (error)', data.error);
              pending.reject(data.error);
            } else {
              logMessage('received', pending.method + ' (response)', data.result);
              pending.resolve(data.result);
            }
            return;
          }

          // Handle notifications from host
          if (data.method) {
            logMessage('received', data.method, data.params);
          }

          // Handle host-context-changed notification
          if (data.method === 'ui/notifications/host-context-changed') {
            if (data.params && data.params.theme) {
              setTheme(data.params.theme);
            }
            updateHostContext(data.params);
          }

          // Handle tool-input notification
          if (data.method === 'ui/notifications/tool-input') {
            currentToolData.toolInput = data.params;
            renderToolData();
          }

          // Handle tool-result notification
          if (data.method === 'ui/notifications/tool-result') {
            currentToolData.toolResult = data.params;
            renderToolData();
          }

          // Handle tool-input-partial notification
          if (data.method === 'ui/notifications/tool-input-partial') {
            currentToolData.toolInputPartial = data.params;
            renderToolData();
          }

          // Handle tool-cancelled notification
          if (data.method === 'ui/notifications/tool-cancelled') {
            currentToolData.toolCancelled = data.params;
            renderToolData();
          }

          // Handle resource-teardown request
          if (data.method === 'ui/resource-teardown') {
            // Send response back to host
            if ('id' in data) {
              window.parent.postMessage({
                jsonrpc: '2.0',
                id: data.id,
                result: {}
              }, '*');
            }
          }
        }

        async function initialize() {
          try {
            const result = await sendRequest('ui/initialize', {
              protocolVersion: '2025-06-18',
              capabilities: {},
              clientInfo: {
                name: 'MCP App Bench',
                version: '1.0.0'
              }
            });

            // Apply initial theme
            if (result.hostContext && result.hostContext.theme) {
              setTheme(result.hostContext.theme);
            }

            initializeHostInfo(result);

            // Send initialized notification
            sendNotification('ui/notifications/initialized');
          } catch (error) {
            document.getElementById('host-info-content').textContent = 'Error: ' + error.message;
          }
        }

        window.addEventListener('message', handleMessage);

        // Action button: Open Link
        document
          .getElementById('btn-open-link')
          .addEventListener('click', function () {
            sendRequest('ui/open-link', {url: 'https://github.com/modelcontextprotocol/ext-apps/blob/main/specification/draft/apps.mdx'})
              .then(function (result) {
                console.log('[MCP App Bench] ui/open-link response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] ui/open-link error:', error);
              });
          });

        // Action button: Send Message
        document
          .getElementById('btn-message')
          .addEventListener('click', function () {
            sendRequest('ui/message', {
              role: 'user',
              content: {
                type: 'text',
                text: 'Hello from MCP App Demo! This message was sent via ui/message.'
              }
            })
              .then(function (result) {
                console.log('[MCP App Bench] ui/message response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] ui/message error:', error);
              });
          });

        // Action button: Size Change (reports actual body size)
        document
          .getElementById('btn-size-change')
          .addEventListener('click', function () {
            sendSizeChanged();
            console.log('[MCP App Bench] ui/notifications/size-changed sent (no response expected)');
          });

        // Action button: Call Tool
        document
          .getElementById('btn-tools-call')
          .addEventListener('click', function () {
            sendRequest('tools/call', {
              name: 'get-server-time',
              arguments: {}
            })
              .then(function (result) {
                console.log('[MCP App Bench] tools/call response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] tools/call error:', error);
              });
          });

        // Action button: List Resources
        document
          .getElementById('btn-resources-list')
          .addEventListener('click', function () {
            sendRequest('resources/list', {})
              .then(function (result) {
                console.log('[MCP App Bench] resources/list response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] resources/list error:', error);
              });
          });

        // Action button: List Resource Templates
        document
          .getElementById('btn-resources-templates-list')
          .addEventListener('click', function () {
            sendRequest('resources/templates/list', {})
              .then(function (result) {
                console.log('[MCP App Bench] resources/templates/list response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] resources/templates/list error:', error);
              });
          });

        // Action button: Read Resource
        document
          .getElementById('btn-resources-read')
          .addEventListener('click', function () {
            sendRequest('resources/read', {uri: 'resource://example/demo-resource'})
              .then(function (result) {
                console.log('[MCP App Bench] resources/read response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] resources/read error:', error);
              });
          });

        // Action button: List Prompts
        document
          .getElementById('btn-prompts-list')
          .addEventListener('click', function () {
            sendRequest('prompts/list', {})
              .then(function (result) {
                console.log('[MCP App Bench] prompts/list response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] prompts/list error:', error);
              });
          });

        // Action button: Log Message
        // Note: Per spec this is a notification (no response expected), but we send as request
        // during development to get feedback on whether the host handled it.
        document
          .getElementById('btn-notifications-message')
          .addEventListener('click', function () {
            sendRequest('notifications/message', {
              level: 'info',
              data: 'This is a log message from the MCP App Demo!',
              logger: 'MCP App Bench'
            })
              .then(function (result) {
                console.log('[MCP App Bench] notifications/message response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] notifications/message error:', error);
              });
          });

        // Action button: Ping
        document
          .getElementById('btn-ping')
          .addEventListener('click', function () {
            sendRequest('ping', {})
              .then(function (result) {
                console.log('[MCP App Bench] ping response:', result);
              })
              .catch(function (error) {
                console.error('[MCP App Bench] ping error:', error);
              });
          });

        // Send initial size
        sendSizeChanged();

        // Observe size changes
        const resizeObserver = new ResizeObserver(sendSizeChanged);
        resizeObserver.observe(document.body);

        // Start initialization
        initialize();
      })();
    </script>
  </body>
</html>
